-- SERVIÇO BÁSICO
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local player = Players.LocalPlayer
local mouse = player:GetMouse()

-- TOOL PORTAL
local tool = Instance.new("Tool")
tool.Name = "Portal Gun"
tool.RequiresHandle = false
tool.Parent = player:WaitForChild("Backpack")

-- VARIÁVEIS DE PORTAL
local portalA = nil
local portalB = nil
local placingA = true
local cooldown = {}
local TELEPORT_DELAY = 1

-- CRIA PORTAL
local function createPortal(position, color)
	local portal = Instance.new("Part")
	portal.Size = Vector3.new(4, 6, 0.2)
	portal.Anchored = true
	portal.CanCollide = false
	portal.Position = position
	portal.Color = color
	portal.Material = Enum.Material.Neon
	portal.Name = "Portal_" .. tostring(color)
	portal.Parent = Workspace
	return portal
end

-- VERIFICA POSIÇÃO (metade do corpo)
local function isInsidePortal(part, portal)
	local relative = portal.CFrame:PointToObjectSpace(part.Position)
	return math.abs(relative.X) <= 2 and math.abs(relative.Y) <= 3 and relative.Z > -0.5 and relative.Z < 0.5
end

-- CONECTAR PORTAIS
local function connectPortals(fromPortal, toPortal)
	RunService.Heartbeat:Connect(function()
		for _, character in ipairs(Workspace:GetChildren()) do
			local root = nil

			if character:IsA("Model") and character:FindFirstChild("HumanoidRootPart") then
				root = character.HumanoidRootPart
			end

			if root and isInsidePortal(root, fromPortal) then
				if cooldown[root] and tick() - cooldown[root] < TELEPORT_DELAY then continue end
				cooldown[root] = tick()

				local offset = fromPortal.CFrame:toObjectSpace(root.CFrame)
				local targetCFrame = toPortal.CFrame:toWorldSpace(offset) + Vector3.new(0, 0.5, 0)
				root.CFrame = targetCFrame
			end
		end
	end)
end

-- BOTÃO X PARA APAGAR PORTAIS
local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
gui.Name = "PortalUI"
gui.ResetOnSpawn = false

local closeButton = Instance.new("TextButton")
closeButton.Size = UDim2.new(0, 40, 0, 40)
closeButton.Position = UDim2.new(0, 10, 0, 10)
closeButton.Text = "X"
closeButton.TextScaled = true
closeButton.BackgroundColor3 = Color3.fromRGB(255, 80, 80)
closeButton.TextColor3 = Color3.new(1, 1, 1)
closeButton.ZIndex = 10
closeButton.Active = true
closeButton.Draggable = true
closeButton.Parent = gui

closeButton.MouseButton1Click:Connect(function()
	if portalA then portalA:Destroy() portalA = nil end
	if portalB then portalB:Destroy() portalB = nil end
	placingA = true
end)

-- USAR A TOOL PARA CRIAR PORTAIS
tool.Activated:Connect(function()
	local target = mouse.Hit
	if not target then return end
	local pos = target.Position + Vector3.new(0, 3, 0)

	if placingA then
		if portalA then portalA:Destroy() end
		portalA = createPortal(pos, Color3.fromRGB(0, 170, 255))
	else
		if portalB then portalB:Destroy() end
		portalB = createPortal(pos, Color3.fromRGB(255, 85, 0))
	end

	placingA = not placingA

	if portalA and portalB then
		connectPortals(portalA, portalB)
		connectPortals(portalB, portalA)
	end
end)
